# v2からv3への移行計画 (Migration Plan from v2 to v3)

## 1. はじめに (Introduction)

本ドキュメントは、`goat` プロジェクトのv2からv3への移行に関する計画をまとめたものです。
v3の主な目的は、`golang.org/x/tools/go/packages` パッケージへの依存から完全に脱却することです。
これにより、以下の効果が期待されます。

- パッケージ解析処理のパフォーマンス向上
- プロジェクトの依存関係の削減とシンプル化
- Go SDKのバージョンや環境による影響を受けにくい、より安定した動作

## 2. 現状の課題 (Current Issues)

現状のv2実装には、`go/packages` 及び関連する `go list` コマンドへの依存箇所が存在します。

### 2.1. `internal/analyzer/options_analyzer.go` における `go/packages` 依存

- `AnalyzeOptionsV2` 関数は、オプション構造体の解析のために `go/packages` を広範囲に利用しています。これにより、パッケージのロード、型情報や構文木の取得を行っています。
- `go/packages` は多機能である反面、プロジェクト全体の依存関係を解決しようとするため、特定のパッケージの特定構造体のみを分析したい場合にオーバースペックとなり、パフォーマンスに影響を与える可能性があります。
- 代替として `AnalyzeOptionsV3` が構想されていますが、v2時点では型チェック機能や外部パッケージの埋め込み構造体解析が不完全であり、`go/packages` を完全に置き換えるには至っていません。

### 2.2. `internal/loader/lazyload/locator.go` における `go list` 依存

- `GoListLocator` 関数は、パッケージのメタデータ（インポートパス、ファイルリスト、依存関係など）を取得するために、内部で `go list -json` コマンドを実行しています。
- `go list` コマンドも `go/packages` と同様にGoのビルドシステムと連携してパッケージ情報を解決するため、`go/packages` からの完全な脱却を目指す上では、この `go list` への依存も解消する必要があります。

## 3. v3の設計方針と主要コンポーネント (v3 Design Principles and Key Components)

`go/packages` と `go list` からの脱却を実現するために、以下の主要コンポーネントの設計・実装をv3の核とします。

### 3.1. 軽量パッケージローダー

- `internal/loader/loader.go` と `internal/loader/lazyload/` の機能を統合・再設計し、新たな軽量パッケージローダーを構築します。
- **責務**:
    - インポートパスからパッケージのディレクトリやソースファイルを特定する（`go/build` の限定的な利用や `go.mod` の解析を検討）。
    - 要求に応じてソースファイルをパースしASTを生成する。
    - パッケージの基本的なメタ情報（インポートパス、パッケージ名、ファイルリストなど）を提供する。
    - 遅延読み込みの概念を維持し、必要な情報のみをオンデマンドでロード・解析する。
- **非依存**: `go/packages` および `go list` コマンドには依存しません。

### 3.2. `go/types` ベースの型解析エンジン

- 新しい軽量パッケージローダーが提供するASTを基に、`go/types` パッケージを利用して型チェックを実行し、詳細な型情報を取得・提供するエンジンを構築します。これは主に `AnalyzeOptionsV3` のコア機能として実装されます。
- **責務**:
    - `types.Config` と適切な `types.Importer` (例: `go/importer.Default()` やカスタム実装) を用いることで、依存パッケージを含む型情報を解決する能力を持つ。
    - `types.Checker` を利用して型チェックを実行し、`types.Info` オブジェクトを生成・保持することができる。
    - これにより、構造体フィールド、関数シグネチャ、インターフェース定義などの正確な型情報を取得することが可能になる。
- **型情報活用の検討事項 (Considerations for Type Information Usage)**:
    - **機能拡張の可能性**:
        - オプションのメタデータとして、フィールド型が `encoding.TextUnmarshaler` や `encoding.TextMarshaler` といった特定のインターフェースを実装しているかどうかの情報を含めることが考えられる。これにより、オプション値のカスタムな変換処理などをCLI側でサポートしやすくなる。もしこの情報が必要とされる場合、`go/types` を用いた型解析による判定が有効な手段となる。
        - 同様に、外部パッケージで定義された型や、埋め込み構造体のフィールド詳細（例えばタグやドキュメント）をより深く解析し、オプションメタデータに反映することも、`go/types` を利用することで実現可能性が高まる。これらの機能拡張は、必要性や開発リソースを考慮して検討されるべきである。v3のコア機能としては、まず `go/packages` からの脱却を優先し、型解析エンジンの基盤を整備する。高度な型情報の活用は、その後の拡張フェーズで検討することができる。

### 3.3. `go/types` を利用したインタープリタ実装の構想

- `go/types` によって得られる正確な型情報を活用し、コードの構造や意味を解釈して有用な情報を抽出したり、特定の処理を実行したりする「インタープリタ」の概念を導入します。
- **応用例**:
    - **オプション解析**: `AnalyzeOptionsV3` はこのインタープリタの一例として、構造体定義からコマンドラインオプションのメタデータを生成します。
    - **DIコンテナ情報収集**: 特定の関数シグネチャから依存関係を抽出し、DIコンテナの設定情報を生成します。
    - **モックコード生成**: インターフェース定義からモックオブジェクトの雛形を生成します。
    - **APIドキュメント生成**: 特定のコメント規約やアノテーションを持つ型/関数からドキュメント情報を抽出します。
- このようなインタープリタ群の基盤として、前述の軽量パッケージローダーと型解析エンジンが機能します。

## 4. 提案される移行タスク (Proposed Migration Tasks)

以下のタスクを実行し、v3への移行を実現します。

1.  **軽量パッケージローダーの実装**:
    - `go/packages` と `go list` に依存せず、ASTと基本メタ情報を提供するローダーを開発します。(`loader`と`lazyload`をマージ)
2.  **`go/types` ベースの型解析エンジンの実装**:
    - パッケージASTに対して型チェックを行い、詳細な型情報を提供するエンジンを開発します。
3.  **`AnalyzeOptionsV3` の完全な実装**:
    - 新しいローダーと型解析エンジンを利用し、`go/packages` 非依存のオプション解析機能を実現します。
    - **検討TODO**: `AnalyzeOptionsV3` の機能拡張として、オプションメタデータに `IsTextUnmarshaler`/`IsTextMarshaler` といったプロパティの追加を検討する。この実現には型情報の活用が考えられる。
    - **検討TODO**: 外部パッケージの型や埋め込み構造体のより詳細な解析機能の追加を検討する。この実現にも型情報の活用が考えられる。
4.  **既存機能の置き換えと統合**:
    - `AnalyzeOptionsV2` を新しい `AnalyzeOptionsV3` で置き換えます。
    - `GoListLocator` を使用箇所を新しいローダーベースの仕組みで置き換えます。
5.  **`cmd/goat` および `codegen` への影響調査と対応**:
    - パッケージロード方法やオプション解析方法の変更が、既存コマンドの動作や生成コードに与える影響を調査し、必要な修正を行います。
6.  **テストの拡充**:
    - 新しいローダー、型解析エンジン、`AnalyzeOptionsV3` のための単体テストおよび結合テストを作成・拡充します。
7.  **ドキュメントの更新**:
    - 開発者向けドキュメントやユーザードキュメントを更新し、v3での変更点や新しいアーキテクチャについて記述します。本ドキュメント (`docs/migration-v2-to-v3.md`) を最終化します。

## 5. その他 (Miscellaneous)

- `loader` パッケージと `lazyload` パッケージのマージは、v3におけるパッケージ情報取得の統一的なインターフェースを提供することを目的とします。
- `go/types` のサブセットを利用したインタープリタという表現は、特定の目的に応じて `go/types` が提供する豊富な情報の中から必要な部分を選択的に利用することを示唆しています。
